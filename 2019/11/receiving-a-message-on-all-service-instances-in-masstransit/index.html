<!doctype html><html lang=en-nz><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.74.3"><title>Receiving a message on all service instances in MassTransit | Neil's Notes</title><link rel=canonical href=https://blog.nizmow.net/2019/11/receiving-a-message-on-all-service-instances-in-masstransit/><link rel=stylesheet href=https://blog.nizmow.net/css/base.min.f871a228a576fc99ea91ba72e688c16767a9616cdb8cff47e95e2d11c6b706d7.css integrity="sha256-+HGiKKV2/Jnqkbpy5ojBZ2epYWzbjP9H6V4tEca3Btc=" crossorigin=anonymous></head><body><nav class=u-background><div class=u-wrapper><ul class=Banner><li class="Banner-item Banner-item--title"><a class="Banner-link u-clickable" href=https://blog.nizmow.net/>Neil's Notes</a></li><li class=Banner-item><a class="Banner-link u-clickable" href=https://blog.nizmow.net/about/>About</a></li><li class=Banner-item><a class="Banner-link u-clickable" href=https://blog.nizmow.net/posts/>Posts</a></li><li class=Banner-item><a class="Banner-link u-clickable" href=https://blog.nizmow.net/tags/>Tags</a></li></ul></div></nav><main><div class=u-wrapper><div class=u-padding><article><header class=Heading><h2 class=Heading-title><a class="Heading-link u-clickable" href=https://blog.nizmow.net/2019/11/receiving-a-message-on-all-service-instances-in-masstransit/ rel=bookmark>Receiving a message on all service instances in MassTransit</a></h2><time datetime=2019-11-19T13:33:09+02:00>19 November, 2019</time></header><p><a href=https://masstransit-project.com>MassTransit</a> is an excellent distributed application framework for .NET that I intend to write more about later. This post documents a solution to a problem you&rsquo;ll probably come across when developing distributed applications with MassTransit.</p><p>MassTransit is built upon a message broker, usually RabbitMQ or Azure Service Bus. MassTransit &ldquo;consumers&rdquo; are attached to message broker queues, to which messages are delivered according to the rules of the message broker. One thing about this that&rsquo;s handy is messages put into a queue are delivered to a consumer only once,<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> which means you can start multiple instances of a service and, since they&rsquo;ll be using the same queue name, you&rsquo;ll get load balancing &ldquo;for free&rdquo;.<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup></p><p>However, in some occasions you might want a message to be received by <em>all</em> of your service instances, and a likely example of this is you broadcast a message that indicates a service might want to clear its cache. With a normal consumer configured to listen to that message, only one of your service instances will receive it and you&rsquo;ll be left with a happily running instance with stale cache.</p><p>Luckily, MassTransit provides a simple way to configure temporary endpoints, exclusive to each instance. All you need to do is configure your receive endpoint without specifying a queue name:</p><div class=highlight><pre class=chroma><code class=language-cs data-lang=cs><span class=n>containerBuilder</span><span class=p>.</span><span class=n>AddMassTransit</span><span class=p>(</span><span class=n>r</span> <span class=p>=&gt;</span>
<span class=p>{</span>
    <span class=n>r</span><span class=p>.</span><span class=n>AddBus</span><span class=p>(</span><span class=n>context</span> <span class=p>=&gt;</span> <span class=n>Bus</span><span class=p>.</span><span class=n>Factory</span><span class=p>.</span><span class=n>CreateUsingInMemory</span><span class=p>(</span><span class=n>cfg</span> <span class=p>=&gt;</span>
    <span class=p>{</span>
        <span class=c1>// a &#39;regular&#39; endpoint
</span><span class=c1></span>        <span class=n>cfg</span><span class=p>.</span><span class=n>ReceiveEndpoint</span><span class=p>(</span><span class=s>&#34;processing_queue&#34;</span><span class=p>,</span> <span class=n>e</span> <span class=p>=&gt;</span> <span class=n>e</span><span class=p>.</span><span class=n>Consumer</span><span class=p>&lt;</span><span class=n>ProcessConsumer</span><span class=p>&gt;(</span><span class=n>context</span><span class=p>));</span>

        <span class=c1>// a temporary endpoint
</span><span class=c1></span>        <span class=n>cfg</span><span class=p>.</span><span class=n>ReceiveEndpoint</span><span class=p>(</span><span class=n>e</span> <span class=p>=&gt;</span> <span class=n>e</span><span class=p>.</span><span class=n>Consumer</span><span class=p>&lt;</span><span class=n>InvalidateCacheConsumer</span><span class=p>&gt;(</span><span class=n>context</span><span class=p>));</span>
    <span class=p>}));</span>
<span class=p>});</span>
</code></pre></div><p>Once starting your application you&rsquo;ll see a queue named something like <code>MYHOST_dotnet_endpoint_8ymoyyn7ywybkygzbdms35zan8</code>. This looks messy, but it&rsquo;s all just to avoid queue naming collisions across services &ndash; as you can see, it&rsquo;s prefixed with the host name of the server, some metadata, and a random(ish) string. It&rsquo;ll be set to auto-delete, meaning it&rsquo;ll disappear when your service does. After all, no point in receiving cache invalidation messages when your service instance isn&rsquo;t running.</p><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p>Actually, <a href=https://www.cloudcomputingpatterns.org/at_least_once_delivery/>at least once</a>. <a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2 role=doc-endnote><p>Well, for the low, low cost of running a message broker. <a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section><footer><ul class=Tags><li class="Tags-item u-background"><a class="Tags-link u-clickable" href=https://blog.nizmow.net/tags/development/ rel=tag>development</a></li><li class="Tags-item u-background"><a class="Tags-link u-clickable" href=https://blog.nizmow.net/tags/masstransit/ rel=tag>masstransit</a></li><li class="Tags-item u-background"><a class="Tags-link u-clickable" href=https://blog.nizmow.net/tags/guide/ rel=tag>guide</a></li></ul></footer></article></div></div></main><footer class=Footer><div class=u-wrapper><div class=u-padding><script>(function(){window.counter='https://blog_nizmow_net.goatcounter.com/count'
var script=document.createElement('script');script.async=1;script.src='//gc.zgo.at/count.js';var ins=document.getElementsByTagName('script')[0];ins.parentNode.insertBefore(script,ins)})();</script></div></div></footer></body></html>