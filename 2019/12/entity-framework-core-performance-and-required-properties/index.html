<!doctype html><html lang=en-nz><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.74.3"><title>Entity Framework Core performance and required properties | Neil's Notes</title><link rel=canonical href=https://blog.nizmow.net/2019/12/entity-framework-core-performance-and-required-properties/><link rel=stylesheet href=https://blog.nizmow.net/css/base.min.f871a228a576fc99ea91ba72e688c16767a9616cdb8cff47e95e2d11c6b706d7.css integrity="sha256-+HGiKKV2/Jnqkbpy5ojBZ2epYWzbjP9H6V4tEca3Btc=" crossorigin=anonymous></head><body><nav class=u-background><div class=u-wrapper><ul class=Banner><li class="Banner-item Banner-item--title"><a class="Banner-link u-clickable" href=https://blog.nizmow.net/>Neil's Notes</a></li><li class=Banner-item><a class="Banner-link u-clickable" href=https://blog.nizmow.net/about/>About</a></li><li class=Banner-item><a class="Banner-link u-clickable" href=https://blog.nizmow.net/posts/>Posts</a></li><li class=Banner-item><a class="Banner-link u-clickable" href=https://blog.nizmow.net/tags/>Tags</a></li></ul></div></nav><main><div class=u-wrapper><div class=u-padding><article><header class=Heading><h2 class=Heading-title><a class="Heading-link u-clickable" href=https://blog.nizmow.net/2019/12/entity-framework-core-performance-and-required-properties/ rel=bookmark>Entity Framework Core performance and required properties</a></h2><time datetime=2019-12-03T12:47:16+01:00>3 December, 2019</time></header><h3 id=background>Background</h3><p>Entity Framework Core 3.0 was recently released with a lot of changes from 2.2, many of which were <a href=https://docs.microsoft.com/en-us/ef/core/what-is-new/ef-core-3.0/breaking-changes>breaking</a>. That&rsquo;s a pretty big list. Since I was updating projects to .NET Core 3.0, I decided to upgrade a small project to EF Core 3.0 and see what I&rsquo;d have to go through for an upgrade against larger projects.</p><p>I ran into a breaking change straight away, and it&rsquo;s the one I&rsquo;ve seen the most activity about: <a href=https://docs.microsoft.com/en-us/ef/core/what-is-new/ef-core-3.0/breaking-changes#linq-queries-are-no-longer-evaluated-on-the-client>LINQ queries are no longer evaluated on the client</a>. <em>Most</em> of the time this happens it&rsquo;s caught as a run-time error when a query that can&rsquo;t be evaluated as a single SQL statement is executed, but sometimes it can be more subtle. Fortunately for me it was caught with a unit test using SQLite in-memory mode.<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></p><p>There have been &ldquo;soft breaking&rdquo; changes that result in performance regressions, and a bit of digging around revealed some projects on GitHub having issues with <a href=https://docs.microsoft.com/en-us/ef/core/what-is-new/ef-core-3.0/breaking-changes#eager-loading-single-query>&ldquo;Eager loading of related entities now happens in a single query&rdquo;</a>. Basically, eager loading would previously issue as a sequence of <code>SELECT</code> statements that were merged in-memory, but in EF Core 3.0 it&rsquo;s a bunch of joins which can be MUCH slower. It actually seems to be a side effect of the first issue, the new EF policy of doing no evaluation on the client.</p><p>After fixing my small issue, I ran up the application and ran some basic integration tests. Everything seemed fine, so I dropped it onto a test environment to push some more load through, and I quickly realised performance had taken a <em>dramatic</em> turn for the worse &ndash; <em>at least an order of magnitude slower</em> than the EF Core 2.0 version. The database use in this application was trivial, but I still went to the trouble of creating a scenario that was as simple as possible. In this, application did nothing more than execute a bunch of <code>SELECT x FROM y WHERE z</code>, and performance was still terrible. Something was up.</p><h3 id=the-problem>The problem</h3><p>I checked the logs to work out exactly what SQL was being executed. In the previous &ldquo;good&rdquo; version of the code, on EF 2.2, it was the following:</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>SELECT</span> <span class=p>[</span><span class=n>l</span><span class=p>].[</span><span class=n>CorrelationId</span><span class=p>],</span> <span class=p>[</span><span class=n>l</span><span class=p>].[</span><span class=n>BatchReferenceId</span><span class=p>],</span> <span class=p>[</span><span class=n>l</span><span class=p>].[</span><span class=n>ContentReferenceId</span><span class=p>],</span> <span class=p>[</span><span class=n>l</span><span class=p>].[</span><span class=n>CurrentState</span><span class=p>],</span> <span class=p>[</span><span class=n>l</span><span class=p>].[</span><span class=n>RowVersion</span><span class=p>],</span> <span class=p>[</span><span class=n>l</span><span class=p>].[</span><span class=n>SourceId</span><span class=p>],</span> <span class=p>[</span><span class=n>l</span><span class=p>].[</span><span class=n>StoredAt</span><span class=p>],</span> <span class=p>[</span><span class=n>l</span><span class=p>].[</span><span class=k>Version</span><span class=p>]</span>
<span class=k>FROM</span> <span class=p>[</span><span class=n>LifeCycle</span><span class=p>]</span> <span class=k>AS</span> <span class=p>[</span><span class=n>l</span><span class=p>]</span>
<span class=k>WHERE</span> <span class=p>(</span><span class=o>@</span><span class=n>__SourceId_0</span> <span class=o>=</span> <span class=p>[</span><span class=n>l</span><span class=p>].[</span><span class=n>SourceId</span><span class=p>])</span> <span class=k>AND</span> <span class=p>(</span><span class=o>@</span><span class=n>__ContentReferenceId_1</span> <span class=o>=</span> <span class=p>[</span><span class=n>l</span><span class=p>].[</span><span class=n>ContentReferenceId</span><span class=p>])</span>
</code></pre></div><p>The EF 3.0 code, however, was executing this:</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>SELECT</span> <span class=p>[</span><span class=n>l</span><span class=p>].[</span><span class=n>CorrelationId</span><span class=p>],</span> <span class=p>[</span><span class=n>l</span><span class=p>].[</span><span class=n>BatchReferenceId</span><span class=p>],</span> <span class=p>[</span><span class=n>l</span><span class=p>].[</span><span class=n>ContentReferenceId</span><span class=p>],</span> <span class=p>[</span><span class=n>l</span><span class=p>].[</span><span class=n>CurrentState</span><span class=p>],</span> <span class=p>[</span><span class=n>l</span><span class=p>].[</span><span class=n>RowVersion</span><span class=p>],</span> <span class=p>[</span><span class=n>l</span><span class=p>].[</span><span class=n>SourceId</span><span class=p>],</span> <span class=p>[</span><span class=n>l</span><span class=p>].[</span><span class=n>StoredOrResentAt</span><span class=p>],</span> <span class=p>[</span><span class=n>l</span><span class=p>].[</span><span class=k>Version</span><span class=p>]</span>
<span class=k>FROM</span> <span class=p>[</span><span class=n>LifeCycle</span><span class=p>]</span> <span class=k>AS</span> <span class=p>[</span><span class=n>l</span><span class=p>]</span>
<span class=k>WHERE</span> <span class=p>(((</span><span class=o>@</span><span class=n>__SourceId_0</span> <span class=o>=</span> <span class=p>[</span><span class=n>l</span><span class=p>].[</span><span class=n>SourceId</span><span class=p>])</span> <span class=k>AND</span> <span class=p>(</span><span class=o>@</span><span class=n>__SourceId_0</span> <span class=k>IS</span> <span class=k>NOT</span> <span class=k>NULL</span> <span class=k>AND</span> <span class=p>[</span><span class=n>l</span><span class=p>].[</span><span class=n>SourceId</span><span class=p>]</span> <span class=k>IS</span> <span class=k>NOT</span> <span class=k>NULL</span><span class=p>))</span> <span class=k>OR</span> <span class=p>(</span><span class=o>@</span><span class=n>__SourceId_0</span> <span class=k>IS</span> <span class=k>NULL</span> <span class=k>AND</span> <span class=p>[</span><span class=n>l</span><span class=p>].[</span><span class=n>SourceId</span><span class=p>]</span> <span class=k>IS</span> <span class=k>NULL</span><span class=p>))</span> <span class=k>AND</span> <span class=p>(((</span><span class=o>@</span><span class=n>__ContentReferenceId_1</span> <span class=o>=</span> <span class=p>[</span><span class=n>l</span><span class=p>].[</span><span class=n>ContentReferenceId</span><span class=p>])</span> <span class=k>AND</span> <span class=p>(</span><span class=o>@</span><span class=n>__ContentReferenceId_1</span> <span class=k>IS</span> <span class=k>NOT</span> <span class=k>NULL</span> <span class=k>AND</span> <span class=p>[</span><span class=n>l</span><span class=p>].[</span><span class=n>ContentReferenceId</span><span class=p>]</span> <span class=k>IS</span> <span class=k>NOT</span> <span class=k>NULL</span><span class=p>))</span> <span class=k>OR</span> <span class=p>(</span><span class=o>@</span><span class=n>__ContentReferenceId_1</span> <span class=k>IS</span> <span class=k>NULL</span> <span class=k>AND</span> <span class=p>[</span><span class=n>l</span><span class=p>].[</span><span class=n>ContentReferenceId</span><span class=p>]</span> <span class=k>IS</span> <span class=k>NULL</span><span class=p>))</span>
</code></pre></div><p>What&rsquo;s going on? Let&rsquo;s start with <code>NULL</code>. As you may or may not be aware, in TSQL/SQL Server, <code>NULL</code> is not equal to <code>NULL</code>. Ever wonder why you have to use <code>IS NULL</code> or similar when writing your SQL queries? That&rsquo;s why. Try it for yourself:</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>SELECT</span> <span class=n>IIF</span><span class=p>(</span><span class=k>NULL</span> <span class=o>=</span> <span class=k>NULL</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</code></pre></div><p>Now this:</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>SELECT</span> <span class=n>IIF</span><span class=p>(</span><span class=k>NULL</span> <span class=k>IS</span> <span class=k>NULL</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</code></pre></div><p>Knowing this, and looking closely at the <code>WHERE</code> clause of the SQL query, you&rsquo;ll see it&rsquo;s not completely insane. Let&rsquo;s do some formatting:</p><div class=highlight><pre class=chroma><code class=language-sql data-lang=sql><span class=k>SELECT</span> <span class=p>[</span><span class=n>l</span><span class=p>].[</span><span class=n>CorrelationId</span><span class=p>],</span> <span class=p>[</span><span class=n>l</span><span class=p>].[</span><span class=n>BatchReferenceId</span><span class=p>],</span> <span class=p>[</span><span class=n>l</span><span class=p>].[</span><span class=n>ContentReferenceId</span><span class=p>],</span> <span class=p>[</span><span class=n>l</span><span class=p>].[</span><span class=n>CurrentState</span><span class=p>],</span> <span class=p>[</span><span class=n>l</span><span class=p>].[</span><span class=n>RowVersion</span><span class=p>],</span> <span class=p>[</span><span class=n>l</span><span class=p>].[</span><span class=n>SourceId</span><span class=p>],</span> <span class=p>[</span><span class=n>l</span><span class=p>].[</span><span class=n>StoredOrResentAt</span><span class=p>],</span> <span class=p>[</span><span class=n>l</span><span class=p>].[</span><span class=k>Version</span><span class=p>]</span>
<span class=k>FROM</span> <span class=p>[</span><span class=n>LifeCycle</span><span class=p>]</span> <span class=k>AS</span> <span class=p>[</span><span class=n>l</span><span class=p>]</span>
<span class=k>WHERE</span> 
<span class=p>(</span>
    <span class=p>(</span>
        <span class=p>(</span><span class=o>@</span><span class=n>__SourceId_0</span> <span class=o>=</span> <span class=p>[</span><span class=n>l</span><span class=p>].[</span><span class=n>SourceId</span><span class=p>])</span>
        <span class=k>AND</span>
        <span class=p>(</span><span class=o>@</span><span class=n>__SourceId_0</span> <span class=k>IS</span> <span class=k>NOT</span> <span class=k>NULL</span> <span class=k>AND</span> <span class=p>[</span><span class=n>l</span><span class=p>].[</span><span class=n>SourceId</span><span class=p>]</span> <span class=k>IS</span> <span class=k>NOT</span> <span class=k>NULL</span><span class=p>)</span>
    <span class=p>)</span>
    <span class=k>OR</span> 
    <span class=p>(</span><span class=o>@</span><span class=n>__SourceId_0</span> <span class=k>IS</span> <span class=k>NULL</span> <span class=k>AND</span> <span class=p>[</span><span class=n>l</span><span class=p>].[</span><span class=n>SourceId</span><span class=p>]</span> <span class=k>IS</span> <span class=k>NULL</span><span class=p>)</span>
<span class=p>)</span> 
<span class=k>AND</span> 
<span class=p>(</span>
    <span class=p>(</span>
        <span class=p>(</span><span class=o>@</span><span class=n>__ContentReferenceId_1</span> <span class=o>=</span> <span class=p>[</span><span class=n>l</span><span class=p>].[</span><span class=n>ContentReferenceId</span><span class=p>])</span> 
        <span class=k>AND</span>
        <span class=p>(</span><span class=o>@</span><span class=n>__ContentReferenceId_1</span> <span class=k>IS</span> <span class=k>NOT</span> <span class=k>NULL</span> <span class=k>AND</span> <span class=p>[</span><span class=n>l</span><span class=p>].[</span><span class=n>ContentReferenceId</span><span class=p>]</span> <span class=k>IS</span> <span class=k>NOT</span> <span class=k>NULL</span><span class=p>)</span>
    <span class=p>)</span> 
    <span class=k>OR</span> <span class=p>(</span><span class=o>@</span><span class=n>__ContentReferenceId_1</span> <span class=k>IS</span> <span class=k>NULL</span> <span class=k>AND</span> <span class=p>[</span><span class=n>l</span><span class=p>].[</span><span class=n>ContentReferenceId</span><span class=p>]</span> <span class=k>IS</span> <span class=k>NULL</span><span class=p>)</span>
<span class=p>)</span>
</code></pre></div><h3 id=the-solution>The solution</h3><p>Entity Framework is just trying to protect us from ourselves! What happens if we pass in a <code>NULL</code> for the SourceId parameter, and expect it to match rows in the database with a <code>NULL</code> SourceId? In EF 2.2, we&rsquo;d get no results.<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup> In EF 3.0, however, it would work as expected. But in my case, SourceId is always going to be there, so why this convoluted query? Turns out, I&rsquo;d got sloppy and neglected to set a <code>NOT NULL</code> constraint in my model definition. So, after rectifying that, and a few other properties I&rsquo;d forgotten&mldr;</p><div class=highlight><pre class=chroma><code class=language-cs data-lang=cs><span class=c1>// ...
</span><span class=c1></span>
<span class=n>entityTypeBuilder</span><span class=p>.</span><span class=n>Property</span><span class=p>(</span><span class=n>x</span> <span class=p>=&gt;</span> <span class=n>x</span><span class=p>.</span><span class=n>SourceId</span><span class=p>).</span><span class=n>IsRequired</span><span class=p>();</span>

<span class=c1>// ...and so on...
</span></code></pre></div><p>I re-run my test, the SQL queries look sensible again, and most importantly the performance is back to where it used to be.</p><p>Why is this happening, and how did nothing go wrong before? In Entity Framework &ldquo;full&rdquo; (not Core!) this behaviour is controlled by the <code>DbContextConfiguration.UseDatabaseNullSemantics</code> property, and you can read about it <a href="https://docs.microsoft.com/en-us/dotnet/api/system.data.entity.infrastructure.dbcontextconfiguration.usedatabasenullsemantics?view=entity-framework-6.2.0">here</a>. This appears to have <a href="https://docs.microsoft.com/en-us/dotnet/api/microsoft.entityframeworkcore.dbcontextoptionsbuilder?view=efcore-3.0">vanished</a> in EF Core and is replaced with what I can only describe as frighteningly unpredictable behaviour, though when I get a chance I will do a little more research to find out why.</p><p>I found it surprising that the lack of a constraint in this case would effect performance so significantly, but I think it&rsquo;s a good lesson. It&rsquo;s the case with ORMs, and also with databases in general, that the more information you can give the engine about your data, the less assumptions it has to make and the more performant your queries can be.</p><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p>I strongly recommend testing your data layer as close as possible to the metal as you can - things like this are why! <a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2 role=doc-endnote><p>I think, but this really surprises me. Further investigation is required! <a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section><footer><ul class=Tags><li class="Tags-item u-background"><a class="Tags-link u-clickable" href=https://blog.nizmow.net/tags/development/ rel=tag>development</a></li><li class="Tags-item u-background"><a class="Tags-link u-clickable" href=https://blog.nizmow.net/tags/entity-framework/ rel=tag>entity framework</a></li><li class="Tags-item u-background"><a class="Tags-link u-clickable" href=https://blog.nizmow.net/tags/issue/ rel=tag>issue</a></li></ul></footer></article></div></div></main><footer class=Footer><div class=u-wrapper><div class=u-padding><script>(function(){window.counter='https://blog_nizmow_net.goatcounter.com/count'
var script=document.createElement('script');script.async=1;script.src='//gc.zgo.at/count.js';var ins=document.getElementsByTagName('script')[0];ins.parentNode.insertBefore(script,ins)})();</script></div></div></footer></body></html>